{% extends "base.html" %}

{% block title %}Periods for {{ user.get_profile.full_name }}{% endblock %}

{% block head %}
	<link rel='stylesheet' type='text/css' href='{{ STATIC_URL }}fullcalendar/fullcalendar.css' />
    <script type='text/javascript' src='{{ STATIC_URL }}js/jquery.js'></script>
    <script type='text/javascript' src='{{ STATIC_URL }}fullcalendar/fullcalendar.js'></script>

	<script type='text/javascript'>
		$(document).ready(function() {
            $('#calendar').fullCalendar({
                events: function(start, end, callback) {
                    $.ajax({
                        url: '{{ periods_url }}',
                        dataType: 'json',
                        data: {
                            start_date__gte: start.toJSON().split('T')[0],
                            start_date__lte: end.toJSON().split('T')[0]
                        },
                        success: function(doc) {
                            var events = [];
                            $(doc.objects).each(function() {
                                events.push({
                                    title: 'period',
                                    start: $(this).attr('start_date'),
                                    period_id: $(this).attr('id')
                                });
                            });
                            callback(events);
                        }
                    });
                },
                dayClick: function() {
                    var start_date = arguments[0].toJSON().split('T')[0];
                    var data = {'start_date': start_date};
                    var now = new Date();
                    if (arguments[0].getDate() == now.getDate()) {
                        data['start_time'] = now.toLocaleTimeString();
                    }
                    $.ajax({
                        url: '{{ periods_url }}',
                        contentType: 'application/json',
                        type: 'POST',
                        data: JSON.stringify(data),
                        // The ``X-CSRFToken`` evidently can't be set in the
                        // ``headers`` option, so force it here.
                        // This method requires jQuery 1.5+.
                        beforeSend: function(jqXHR, settings) {
                            // Pull the token out of the DOM.
                            jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
                        },
                        success: function(data, textStatus, jqXHR) {
                            console.log("Period created starting on " + start_date);
                            $('#calendar').fullCalendar( 'refetchEvents' );
                        }
                    });

                },
                eventClick: function() {
                    var period_id = arguments[0].period_id;
                    $.ajax({
                        url: '{{ periods_url }}' + period_id + '/',
                        contentType: 'application/json',
                        type: 'DELETE',
                        // The ``X-CSRFToken`` evidently can't be set in the
                        // ``headers`` option, so force it here.
                        // This method requires jQuery 1.5+.
                        beforeSend: function(jqXHR, settings) {
                            // Pull the token out of the DOM.
                            jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
                        },
                        success: function(data, textStatus, jqXHR) {
                            console.log("Period " + period_id + " deleted.");
                            $('#calendar').fullCalendar( 'refetchEvents' );
                        }
                    });

                }
            })
        });
	</script>
{% endblock %}

{% block content %}
	<h1>Periods for {{ user.get_profile.full_name }}</h1>

    <div id='calendar'></div>
    <!-- Include the CSRF token in the body of the HTML -->
    {% csrf_token %}
{% endblock %}
